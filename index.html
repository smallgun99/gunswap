<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0x v2 交換 App (v2.1 Oku 複製版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 2px solid rgba(255,255,255,.3); border-top-color: white; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const POLYGON_CHAIN_ID = 137;
        const WETH_ADDRESS = '0x7ceb23fd6bc0add59e62ac25578270cff1b9f619';
        const DAI_ADDRESS = '0x8f3cf7ad23cd3cadbd9735aff958023239c6a063';
        const WETH_DECIMALS = 18;
        const DAI_DECIMALS = 18;
        const PERMIT2_ADDRESS = '0x000000000022d473030f116ddee9f6b43ac78ba3';
        const ERC20_ABI = ["function allowance(address owner, address spender) view returns (uint256)", "function approve(address spender, uint256 amount) returns (bool)", "function balanceOf(address account) view returns (uint256)"];

        // Custom hook for debouncing
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                return () => {
                    clearTimeout(handler);
                };
            }, [value, delay]);
            return debouncedValue;
        }

        function App() {
            const [signer, setSigner] = useState(null);
            const [userAddress, setUserAddress] = useState(null);
            const [sellAmount, setSellAmount] = useState('0.001');
            const [buyAmount, setBuyAmount] = useState('');
            const [quote, setQuote] = useState(null);
            const [wethBalance, setWethBalance] = useState('0.0');
            const [isLoading, setIsLoading] = useState(false);
            const [isSwapping, setIsSwapping] = useState(false);
            const [message, setMessage] = useState({ text: '請先連接錢包', type: 'info' });
            const [needsApproval, setNeedsApproval] = useState(false);

            const debouncedSellAmount = useDebounce(sellAmount, 500);

            const fetchBalance = useCallback(async (currentSigner, currentAddress) => {
                if (!currentSigner || !currentAddress) return;
                try {
                    const weth = new ethers.Contract(WETH_ADDRESS, ERC20_ABI, currentSigner);
                    const wethBal = await weth.balanceOf(currentAddress);
                    setWethBalance(ethers.utils.formatUnits(wethBal, WETH_DECIMALS));
                } catch (e) { console.error("讀取餘額失敗:", e); }
            }, []);

            const connectWallet = useCallback(async () => {
                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    const network = await provider.getNetwork();
                    if (network.chainId !== POLYGON_CHAIN_ID) return setMessage({ text: '請切換到 Polygon 網路', type: 'error' });
                    const web3Signer = provider.getSigner();
                    const address = await web3Signer.getAddress();
                    setSigner(web3Signer);
                    setUserAddress(address);
                    setMessage({ text: '', type: 'success' });
                    await fetchBalance(web3Signer, address);
                } catch (e) { setMessage({ text: '連接錢包失敗', type: 'error' }); }
            }, [fetchBalance]);

            useEffect(() => {
                if (window.ethereum) {
                    const handler = (accounts) => {
                        if (accounts.length > 0 && accounts[0] !== userAddress) {
                            connectWallet();
                        } else if (accounts.length === 0) {
                             setUserAddress(null); setSigner(null); setMessage({ text: '請先連接錢包', type: 'info' });
                        }
                    }
                    window.ethereum.on('accountsChanged', handler);
                    return () => window.ethereum.removeListener('accountsChanged', handler);
                }
            }, [userAddress, connectWallet]);
            
            const getQuote = useCallback(async () => {
                if (!debouncedSellAmount || parseFloat(debouncedSellAmount) <= 0 || !signer) return;
                setIsLoading(true);
                setNeedsApproval(false);
                setMessage({ text: '', type: 'info' });
                
                try {
                    const sellAmountInWei = ethers.utils.parseUnits(debouncedSellAmount, WETH_DECIMALS);
                    
                    const params = new URLSearchParams({
                        chainId: POLYGON_CHAIN_ID,
                        sellToken: WETH_ADDRESS,
                        buyToken: DAI_ADDRESS,
                        sellAmount: sellAmountInWei.toString(),
                        taker: userAddress,
                        permit2Address: PERMIT2_ADDRESS,
                        slippagePercentage: '0.01' // Standard 1% slippage
                    });
                    
                    const response = await fetch(`/api/quote?${params}`);
                    const result = await response.json();

                    if (!response.ok || result.error) {
                        const errorReason = result.reason || (result.validationErrors && result.validationErrors[0].description) || result.message || '無法獲取報價';
                        throw new Error(errorReason);
                    }
                    
                    if (!result.permit2 || !result.permit2.eip712 || !result.transaction || !result.transaction.to) {
                       throw new Error(`API 回傳的報價不完整`);
                    }

                    setQuote(result);
                    setBuyAmount(ethers.utils.formatUnits(result.buyAmount, DAI_DECIMALS));

                    const wethContract = new ethers.Contract(WETH_ADDRESS, ERC20_ABI, signer);
                    const allowance = await wethContract.allowance(userAddress, result.allowanceTarget);

                    if (allowance.lt(sellAmountInWei)) {
                        setNeedsApproval(true);
                    }
                } catch (error) {
                    setMessage({ text: error.message, type: 'error' });
                    setBuyAmount('');
                    setQuote(null);
                } finally {
                    setIsLoading(false);
                }
            }, [debouncedSellAmount, signer, userAddress]);

             useEffect(() => {
                getQuote();
            }, [debouncedSellAmount, getQuote]);

            const approve = async () => {
                if (!quote) return;
                setIsSwapping(true);
                setMessage({ text: '請在錢包中確認授權...', type: 'info' });
                try {
                    const wethContract = new ethers.Contract(WETH_ADDRESS, ERC20_ABI, signer);
                    const approveTx = await wethContract.approve(quote.allowanceTarget, ethers.constants.MaxUint256);
                    await approveTx.wait();
                    setNeedsApproval(false);
                    setMessage({ text: '授權成功！', type: 'success' });
                } catch (e) { setMessage({ text: '授權失敗', type: 'error' }); } finally {
                    setIsSwapping(false);
                }
            };
            
            const swap = async () => {
                if (!quote) return;
                setIsSwapping(true);
                setMessage({ text: '請在錢包中簽名 (免費)...', type: 'info' });

                try {
                    const { domain, types, message: permitMessage } = quote.permit2.eip712;
                    const typesForSignature = { ...types };
                    delete typesForSignature.EIP712Domain;

                    const signature = await signer._signTypedData(domain, typesForSignature, permitMessage);
                    
                    setMessage({ text: '簽名成功！請在錢包中確認交易...', type: 'info' });
                    
                    const tx = {
                        ...quote.transaction,
                        data: `${quote.transaction.data}${signature.substring(2)}`,
                    };
                    
                    delete tx.gasPrice;
                    delete tx.gas;

                    const txResponse = await signer.sendTransaction(tx);
                    await txResponse.wait();
                    
                    setMessage({ text: '交換成功！', type: 'success' });
                    await fetchBalance(signer, userAddress);
                    setQuote(null);
                    setSellAmount('');
                    setBuyAmount('');
                } catch (e) { 
                    setMessage({ text: `操作失敗: ${e.reason || '使用者拒絕交易'}`, type: 'error' }); 
                } finally {
                    setIsSwapping(false);
                }
            };

            const getButton = () => {
                if (!userAddress) {
                    return <button onClick={connectWallet} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl transition">連接錢包</button>;
                }
                if (needsApproval) {
                    return <button onClick={approve} disabled={isSwapping} className="w-full flex justify-center items-center bg-pink-600 hover:bg-pink-700 text-white font-bold py-4 px-4 rounded-xl transition disabled:opacity-50">{isSwapping ? <div className="spinner"></div> : '授權 WETH'}</button>;
                }
                const swapDisabled = isSwapping || isLoading || !quote || !buyAmount;
                return <button onClick={swap} disabled={swapDisabled} className="w-full flex justify-center items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl transition disabled:bg-gray-700 disabled:text-gray-400 disabled:cursor-not-allowed">{isSwapping ? <div className="spinner"></div> : 'Swap'}</button>;
            };

            return (
                <div className="w-full max-w-md mx-auto bg-gray-800 rounded-2xl p-5 shadow-2xl space-y-4 border border-gray-700">
                    <div className="p-2 bg-gray-900 rounded-lg">
                        <div className="flex justify-between items-center mb-1 text-sm text-gray-400 px-1">
                            <span>您賣出</span>
                            <span>餘額: {wethBalance ? parseFloat(wethBalance).toFixed(5) : '0.0'}</span>
                        </div>
                        <div className="flex items-center">
                            <input type="text" placeholder="0.0" className="bg-transparent w-full text-3xl text-white focus:outline-none p-1" value={sellAmount} onChange={e => setSellAmount(e.target.value)} disabled={!userAddress} />
                            <div className="flex items-center bg-gray-700 rounded-full px-3 py-2 ml-2">
                                <img src="https://s2.coinmarketcap.com/static/img/coins/64x64/2396.png" alt="WETH" className="w-6 h-6 mr-2 rounded-full"/>
                                <span className="font-bold text-lg">WETH</span>
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex justify-center my-[-8px] z-10">
                        <button className="p-2 bg-gray-700 hover:bg-gray-600 rounded-full border-4 border-gray-800">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
                        </button>
                    </div>

                    <div className="p-2 bg-gray-900 rounded-lg">
                        <div className="flex justify-between items-center mb-1 text-sm text-gray-400 px-1">
                            <span>您買入</span>
                            {isLoading ? <div className="spinner w-4 h-4"></div> : <span>{quote ? `~ $${(parseFloat(buyAmount) * parseFloat(quote.buyTokenToEthRate || '0')).toFixed(2)}` : ''}</span>}
                        </div>
                        <div className="flex items-center">
                            <div className="w-full text-3xl text-white p-1">{buyAmount ? parseFloat(buyAmount).toFixed(5) : '0.0'}</div>
                            <div className="flex items-center bg-gray-700 rounded-full px-3 py-2 ml-2">
                                <img src="https://s2.coinmarketcap.com/static/img/coins/64x64/4943.png" alt="DAI" className="w-6 h-6 mr-2 rounded-full"/>
                                <span className="font-bold text-lg">DAI</span>
                            </div>
                        </div>
                    </div>
                    
                    {getButton()}

                    <div className={`text-center text-sm h-5 flex items-center justify-center break-all ${message.type === 'error' ? 'text-red-400' : 'text-green-400'}`}>
                        {message.text}
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

