<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0x v2 API 偵錯器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 2px solid rgba(255,255,255,.3); border-top-color: white; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const POLYGON_CHAIN_ID = 137;
        const WETH_ADDRESS = '0x7ceb23fd6bc0add59e62ac25578270cff1b9f619';
        const DAI_ADDRESS = '0x8f3cf7ad23cd3cadbd9735aff958023239c6a063';
        const WETH_DECIMALS = 18;
        const PERMIT2_ADDRESS = '0x000000000022d473030f116ddee9f6b43ac78ba3';

        function App() {
            const [signer, setSigner] = useState(null);
            const [userAddress, setUserAddress] = useState(null);
            const [sellAmount, setSellAmount] = useState('0.001');
            const [isLoading, setIsLoading] = useState(false);
            const [apiResponse, setApiResponse] = useState('等待發送請求...');

            const connectWallet = async () => {
                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    const network = await provider.getNetwork();
                    if (network.chainId !== POLYGON_CHAIN_ID) {
                        setApiResponse(`錯誤：請切換到 Polygon 網路`);
                        return;
                    }
                    const web3Signer = provider.getSigner();
                    const address = await web3Signer.getAddress();
                    setSigner(web3Signer);
                    setUserAddress(address);
                    setApiResponse('錢包連接成功，請點擊下方按鈕獲取報價。');
                } catch (e) { setApiResponse(`連接錢包失敗: ${e.message}`); }
            };

            const getQuote = async () => {
                if (!signer) {
                    setApiResponse('錯誤：請先連接錢包');
                    return;
                }
                setIsLoading(true);
                setApiResponse('正在向後端發送請求...');
                
                try {
                    const sellAmountInWei = ethers.utils.parseUnits(sellAmount, WETH_DECIMALS);
                    const params = new URLSearchParams({
                        chainId: POLYGON_CHAIN_ID,
                        sellToken: WETH_ADDRESS,
                        buyToken: DAI_ADDRESS,
                        sellAmount: sellAmountInWei.toString(),
                        taker: userAddress,
                        permit2Address: PERMIT2_ADDRESS
                    });
                    
                    const response = await fetch(`/api/quote?${params}`);
                    const resultText = await response.text();
                    
                    // 嘗試格式化 JSON 以便閱讀，如果失敗則直接顯示原始文字
                    try {
                        const json = JSON.parse(resultText);
                        setApiResponse(JSON.stringify(json, null, 2));
                    } catch {
                        setApiResponse(resultText);
                    }

                } catch (error) {
                    setApiResponse(`前端請求失敗: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="w-full max-w-2xl mx-auto bg-gray-800 rounded-2xl p-6 shadow-2xl space-y-6">
                    <div>
                        <h1 className="text-2xl font-bold text-center text-cyan-400">0x v2 API 偵錯器</h1>
                        {userAddress ? <div className="text-center text-xs text-gray-500 break-all mt-2">已連接: {userAddress}</div> : <p className="text-sm text-gray-400 text-center mt-1">此工具用於顯示 0x API 的原始回應</p>}
                    </div>

                    <div className="flex items-center space-x-4">
                        <button onClick={connectWallet} disabled={!!userAddress} className="w-1/3 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition disabled:bg-gray-700 disabled:text-gray-400">
                            1. 連接錢包
                        </button>
                        <input type="text" value={sellAmount} onChange={e => setSellAmount(e.target.value)} className="bg-gray-900 rounded-lg p-3 w-1/3 text-center"/>
                        <button onClick={getQuote} disabled={isLoading || !userAddress} className="w-1/3 flex justify-center items-center bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition disabled:bg-gray-600 disabled:cursor-not-allowed">
                            {isLoading ? <div className="spinner"></div> : '2. 獲取報價'}
                        </button>
                    </div>

                    <div className="bg-gray-900 rounded-lg p-4">
                        <h2 className="text-lg font-bold mb-2 text-gray-400">API 原始回應:</h2>
                        <pre className="text-xs text-left whitespace-pre-wrap break-all overflow-auto h-96">{apiResponse}</pre>
                    </div>
                </div>
            );
        }
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

